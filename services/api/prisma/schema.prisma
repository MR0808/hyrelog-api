// HyreLog API - Prisma Schema
// Phase 0: Foundation with multi-region, archival, and GDPR support

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// Enums
// ============================================================

enum Region {
  US
  EU
  UK
  AU
}

enum ApiKeyScope {
  COMPANY
  WORKSPACE
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
}

enum CompanyMemberRole {
  ADMIN
  MEMBER
}

enum GdprRequestStatus {
  CUSTOMER_PENDING
  CUSTOMER_APPROVED
  HYRELOG_APPROVED
  PROCESSING
  DONE
  REJECTED
}

enum GdprApprovalType {
  CUSTOMER_ADMIN
  HYRELOG_ADMIN
}

enum ColdStorageProvider {
  AWS
  AZURE
  GCP
}

enum PlanTier {
  FREE
  STARTER
  GROWTH
  ENTERPRISE
}

enum PlanType {
  STANDARD  // Pre-defined plans (FREE, STARTER, GROWTH, ENTERPRISE)
  CUSTOM   // Custom plans created by admin
}

enum BillingStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
}

enum WebhookStatus {
  ACTIVE
  DISABLED
}

enum WebhookEventType {
  AUDIT_EVENT_CREATED
}

enum WebhookDeliveryStatus {
  PENDING
  SENDING
  SUCCEEDED
  FAILED
  RETRY_SCHEDULED
}

enum ExportFormat {
  JSONL
  CSV
}

enum ExportStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
}

enum ExportSource {
  HOT
  ARCHIVED
  HOT_AND_ARCHIVED
}

enum GlacierRestoreStatus {
  PENDING
  APPROVED
  INITIATING
  IN_PROGRESS
  COMPLETED
  EXPIRED
  FAILED
  CANCELLED
}

enum GlacierRestoreTier {
  EXPEDITED
  STANDARD
  BULK
}

// ============================================================
// Plan Management (Database-Driven)
// ============================================================

model Plan {
  id        String   @id @default(uuid())
  name      String   @unique // e.g., "Free", "Starter", "Growth", "Enterprise", "Acme Corp Custom"
  planTier  PlanTier // For standard plans (FREE, STARTER, GROWTH, ENTERPRISE)
  planType  PlanType @default(STANDARD) // STANDARD or CUSTOM
  
  // Plan configuration (stored in DB for admin dashboard management)
  webhooksEnabled        Boolean @default(false)
  maxWebhooks            Int     @default(0)
  streamingExportsEnabled Boolean @default(false)
  maxExportRows          BigInt  @default(10000)
  hotRetentionDays       Int     @default(7)
  archiveRetentionDays   Int?
  coldArchiveAfterDays   Int?
  allowCustomCategories  Boolean @default(false)
  
  // Metadata
  description String?  // Optional description for admin dashboard
  isActive    Boolean  @default(true) // Can disable plans without deleting
  isDefault   Boolean  @default(false) // Mark default plan for new companies
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  companies Company[]
  
  @@index([planType])
  @@index([planTier])
  @@index([isActive])
  @@map("plans")
}

// ============================================================
// Core Models
// ============================================================

model Company {
  id         String   @id @default(uuid())
  name       String
  dataRegion Region   @default(US)
  
  // Plan assignment (database-driven)
  planId     String   // References Plan (standard or custom) - required after migration
  planTier   PlanTier @default(FREE) // For reference only, planId is source of truth
  planOverrides Json? // Per-company overrides (takes precedence over plan config)

  // Billing metadata (Stripe-ready)
  billingStatus        BillingStatus @default(ACTIVE)
  stripeCustomerId     String?       @unique
  stripeSubscriptionId String?       @unique
  stripePriceId         String?
  trialEndsAt           DateTime?

  createdAt DateTime @default(now())

  // Relations
  plan            Plan              @relation(fields: [planId], references: [id], onDelete: Restrict)
  members         CompanyMember[]
  workspaces      Workspace[]
  apiKeys         ApiKey[]
  auditEvents     AuditEvent[]
  archiveObjects  ArchiveObject[]
  gdprRequests    GdprRequest[]
  webhookEndpoints WebhookEndpoint[]
  exportJobs      ExportJob[]
  auditLogs       AuditLog[]
  restoreRequests GlacierRestoreRequest[]

  @@index([dataRegion])
  @@index([planTier]) // DEPRECATED: Keep for backward compatibility
  @@index([planId])
  @@map("companies")
}

model CompanyMember {
  id        String            @id @default(uuid())
  companyId String
  email     String
  role      CompanyMemberRole @default(MEMBER)
  createdAt DateTime          @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Approvals
  gdprApprovals GdprApproval[]

  @@unique([companyId, email])
  @@index([companyId])
  @@index([email])
  @@map("company_members")
}

model Workspace {
  id        String   @id @default(uuid())
  companyId String
  name      String
  createdAt DateTime @default(now())

  // Relations
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects         Project[]
  apiKeys          ApiKey[]
  auditEvents      AuditEvent[]
  archiveObjects   ArchiveObject[]
  webhookEndpoints WebhookEndpoint[]
  exportJobs       ExportJob[]

  @@index([companyId])
  @@map("workspaces")
}

model Project {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  createdAt   DateTime @default(now())

  // Relations
  workspace        Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  auditEvents      AuditEvent[]
  webhookEndpoints WebhookEndpoint[]
  exportJobs       ExportJob[]

  @@index([workspaceId])
  @@map("projects")
}

// ============================================================
// API Keys
// ============================================================

model ApiKey {
  id        String       @id @default(uuid())
  prefix    String // e.g., "hyk_live_abc123"
  hashedKey String // bcrypt hash of full key
  scope     ApiKeyScope
  status    ApiKeyStatus @default(ACTIVE)

  // Scope references (mutually exclusive)
  companyId   String?
  workspaceId String?

  // Expiration
  expiresAt DateTime?

  // Access control
  ipAllowlist String[] // Array of allowed IPs (empty = all)

  // Metadata
  labels String[] // User-defined labels

  // Key rotation
  rotatedFromId String?
  rotatedToId   String?

  // Usage tracking
  lastUsedAt       DateTime?
  lastUsedIp       String?
  lastUsedEndpoint String?

  createdAt DateTime @default(now())

  // Relations
  company   Company?   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([hashedKey])
  @@index([companyId])
  @@index([workspaceId])
  @@index([scope, status])
  @@map("api_keys")
}

// ============================================================
// Audit Events (Core Data Model)
// ============================================================

model AuditEvent {
  id          String  @id @default(uuid())
  companyId   String
  workspaceId String
  projectId   String?

  // Event data
  timestamp DateTime
  category  String
  action    String

  // Actor information
  actorId    String?
  actorEmail String?
  actorRole  String?

  // Resource information
  resourceType String?
  resourceId   String?

  // Metadata (flexible JSON)
  metadata Json

  // Request context
  traceId   String
  ipAddress String?
  geo       String? // ISO country code or region
  userAgent String?

  // Hash chain
  prevHash String? // Hash of previous event in chain
  hash     String // SHA-256 hash of this event

  // Idempotency
  idempotencyHash String? // SHA-256 hash for idempotency checks

  // Region
  dataRegion Region @default(US)

  // Archival flags
  archivalCandidate Boolean   @default(false)
  archived          Boolean   @default(false)
  archivedAt        DateTime?

  // Cold storage
  isColdArchived Boolean @default(false)
  coldArchiveKey String? // S3 key or equivalent

  createdAt DateTime @default(now())

  // Relations
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Restrict)
  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Restrict)
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: Restrict)
  webhookJobs WebhookJob[]

  @@index([companyId])
  @@index([workspaceId])
  @@index([projectId])
  @@index([timestamp])
  @@index([category])
  @@index([action])
  @@index([dataRegion])
  @@index([archived, archivalCandidate])
  @@index([hash])
  @@index([idempotencyHash])
  @@map("audit_events")
}

// ============================================================
// Region Data Store Configuration
// ============================================================

model RegionDataStore {
  id                  String              @id @default(uuid())
  region              Region              @unique
  dbUrl               String // Encrypted connection string
  readOnlyUrl         String? // Read replica URL (optional)
  s3Bucket            String
  coldStorageProvider ColdStorageProvider @default(AWS)
  createdAt           DateTime            @default(now())

  @@map("region_data_stores")
}

// ============================================================
// Archive Objects (S3/Storage)
// ============================================================

model ArchiveObject {
  id          String  @id @default(uuid())
  companyId   String
  workspaceId String?
  region      Region
  date        String // YYYY-MM-DD format
  s3Key       String // Full S3 key path
  gzSizeBytes Int // Size of gzipped file in bytes
  sha256      String // SHA-256 hash of the archive file
  rowCount    Int? // Number of events in archive

  // Verification
  verifiedAt DateTime? // When archive was verified
  verificationError String? // Error message if verification failed

  // Cold storage
  isColdArchived Boolean @default(false)
  coldArchiveKey String? // Glacier/Deep Archive key
  restoredUntil DateTime? // When restore expires (null if not restored or expired)

  createdAt DateTime @default(now())

  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Restrict)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Restrict)
  restoreRequests GlacierRestoreRequest[]

  @@unique([companyId, workspaceId, region, date])
  @@index([companyId])
  @@index([region, date])
  @@index([isColdArchived])
  @@index([verifiedAt])
  @@index([restoredUntil])
  @@map("archive_objects")
}

// ============================================================
// Export Jobs
// ============================================================

model ExportJob {
  id String @id @default(uuid())

  // Scope
  companyId   String
  workspaceId String?
  projectId   String?

  // Request metadata
  requestedByType String // "API_KEY" for now; later "DASHBOARD_USER"
  requestedById   String? // apiKeyId or memberId later

  // Export configuration
  source ExportSource
  format ExportFormat
  status ExportStatus @default(PENDING)
  filters Json? // Export filters (from, to, category, action, etc.)

  // Progress tracking
  rowLimit    BigInt // Maximum rows to export (from plan limit)
  rowsExported BigInt @default(0) // Actual rows exported

  // Result metadata
  fileS3Key String? // Optional manifest key (not required for streaming)

  // Error tracking
  errorCode    String?
  errorMessage String?

  // Timestamps
  createdAt  DateTime @default(now())
  startedAt DateTime?
  finishedAt DateTime?

  // Relations
  company   Company         @relation(fields: [companyId], references: [id], onDelete: Restrict)
  workspace Workspace?      @relation(fields: [workspaceId], references: [id], onDelete: Restrict)
  project   Project?        @relation(fields: [projectId], references: [id], onDelete: Restrict)
  chunks    ExportJobChunk[]

  @@index([companyId, status, createdAt])
  @@index([status])
  @@index([companyId])
  @@map("export_jobs")
}

model ExportJobChunk {
  id String @id @default(uuid())
  exportJobId String

  // Chunk metadata
  partNumber Int // Sequential part number
  s3Key      String? // S3 key if stored
  sha256     String? // SHA-256 hash of chunk
  rows       BigInt @default(0) // Number of rows in this chunk

  createdAt DateTime @default(now())

  // Relations
  exportJob ExportJob @relation(fields: [exportJobId], references: [id], onDelete: Cascade)

  @@index([exportJobId])
  @@map("export_job_chunks")
}

// ============================================================
// GDPR Workflows
// ============================================================

model GdprRequest {
  id        String @id @default(uuid())
  companyId String

  // Target of the request
  targetType  String // e.g., "USER", "WORKSPACE", "PROJECT", "COMPANY"
  targetValue String // ID or identifier of the target

  // Request type
  requestType String @default("ANONYMIZE") // For now only ANONYMIZE

  // Status workflow
  status GdprRequestStatus @default(CUSTOMER_PENDING)

  // Who created it
  createdByMemberId String

  // Timestamps
  createdAt          DateTime  @default(now())
  approvedAtCustomer DateTime?
  approvedAtHyrelog  DateTime?
  processedAt        DateTime?

  // Relations
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  approvals GdprApproval[]

  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("gdpr_requests")
}

model GdprApproval {
  id            String @id @default(uuid())
  gdprRequestId String

  // Approver type
  approverType GdprApprovalType

  // Approver identity (mutually exclusive based on type)
  approverMemberId String? // For CUSTOMER_ADMIN
  approverEmail    String? // For HYRELOG_ADMIN

  createdAt DateTime @default(now())

  // Relations
  gdprRequest GdprRequest    @relation(fields: [gdprRequestId], references: [id], onDelete: Cascade)
  member      CompanyMember? @relation(fields: [approverMemberId], references: [id], onDelete: SetNull)

  // Ensure uniqueness: one approval per approver type per request
  @@unique([gdprRequestId, approverType, approverMemberId])
  @@unique([gdprRequestId, approverType, approverEmail])
  @@index([gdprRequestId])
  @@map("gdpr_approvals")
}

// ============================================================
// Webhooks (Phase 2)
// ============================================================

model WebhookEndpoint {
  id          String  @id @default(uuid())
  companyId   String
  workspaceId String
  projectId   String? // Optional project scope

  // Configuration
  status          WebhookStatus      @default(ACTIVE)
  url             String
  secretHashed    String // SHA-256 hash of the secret (for verification)
  secretEncrypted String // Encrypted plaintext secret (for signing - decrypt in worker)
  events          WebhookEventType[] // Array of event types

  // Statistics
  lastSuccessAt DateTime?
  lastFailureAt DateTime?
  failureCount  Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  workspace Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  jobs      WebhookJob[]

  @@index([workspaceId])
  @@index([companyId])
  @@index([status])
  @@index([workspaceId, status])
  @@map("webhook_endpoints")
}

model WebhookJob {
  id          String  @id @default(uuid())
  webhookId   String
  eventId     String
  companyId   String
  workspaceId String
  projectId   String?

  // Delivery tracking
  attempt       Int                   @default(1)
  status        WebhookDeliveryStatus @default(PENDING)
  nextAttemptAt DateTime              @default(now())
  lastAttemptAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  webhook  WebhookEndpoint          @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event    AuditEvent               @relation(fields: [eventId], references: [id], onDelete: Restrict)
  attempts WebhookDeliveryAttempt[]

  @@index([nextAttemptAt, status])
  @@index([webhookId])
  @@index([status])
  @@index([eventId])
  @@map("webhook_jobs")
}

model WebhookDeliveryAttempt {
  id        String @id @default(uuid())
  jobId     String
  webhookId String
  eventId   String
  attempt   Int

  // Delivery details
  status            WebhookDeliveryStatus
  requestUrl        String
  requestHeaders    Json
  requestBodySha256 String
  responseStatus    Int?
  responseHeaders   Json?
  errorCode         String?
  errorMessage      String? // Sanitized error message
  durationMs        Int?

  createdAt DateTime @default(now())

  // Relations
  job WebhookJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([webhookId])
  @@index([eventId])
  @@index([status])
  @@map("webhook_delivery_attempts")
}

// ============================================================
// Dashboard Audit Logs (Phase 4)
// ============================================================

model AuditLog {
  id String @id @default(uuid())
  
  // Action details
  action String // e.g., "RESTORE_REQUEST_CREATED", "WEBHOOK_ENABLED", "EXPORT_REQUESTED"
  
  // Actor information (from dashboard headers)
  actorUserId  String
  actorEmail   String
  actorRole    String
  
  // Target company (if company-scoped action)
  targetCompanyId String?
  
  // Request context
  ip       String?
  userAgent String?
  traceId  String?
  
  // Flexible metadata (JSON)
  metadata Json?
  
  createdAt DateTime @default(now())
  
  // Relations
  company Company? @relation(fields: [targetCompanyId], references: [id], onDelete: SetNull)
  
  @@index([targetCompanyId])
  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================
// Glacier Restore Requests (Phase 4)
// ============================================================

model GlacierRestoreRequest {
  id String @id @default(uuid())
  
  // Scope
  companyId String
  region    Region
  archiveId String // References ArchiveObject
  
  // Request details
  requestedByType String // "DASHBOARD_USER" or "API_KEY"
  requestedById   String // userId or apiKeyId
  requestedAt      DateTime @default(now())
  
  // Restore configuration
  tier GlacierRestoreTier
  days Int? // Days to keep restored (default based on tier)
  
  // Status workflow
  status GlacierRestoreStatus @default(PENDING)
  
  // AWS S3 restore tracking
  s3RestoreId String? // AWS restore request ID
  
  // Approval workflow
  initiatedAt DateTime?
  initiatedBy String? // userId or "SYSTEM"
  approvedAt  DateTime?
  approvedBy  String? // userId (HYRELOG_ADMIN)
  rejectedAt DateTime?
  rejectedBy String? // userId (HYRELOG_ADMIN)
  rejectReason String?
  
  // Completion
  completedAt DateTime?
  expiresAt   DateTime? // When restore expires (days after completion)
  errorMessage String?
  
  // Cost tracking
  estimatedCostUsd Decimal? @db.Decimal(10, 4)
  actualCostUsd    Decimal? @db.Decimal(10, 4)
  
  // Cancellation
  cancelledAt DateTime?
  cancelledBy String?
  
  // Relations
  company  Company       @relation(fields: [companyId], references: [id], onDelete: Restrict)
  archive  ArchiveObject @relation(fields: [archiveId], references: [id], onDelete: Restrict)
  
  @@index([companyId, status])
  @@index([archiveId])
  @@index([status, requestedAt])
  @@map("glacier_restore_requests")
}
